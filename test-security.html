<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Security Test Suite</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 40px 20px;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    h1 {
      color: white;
      text-align: center;
      margin-bottom: 40px;
      font-size: 2.5em;
    }
    .test-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    .test-card {
      background: white;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    .test-card h2 {
      color: #333;
      margin-bottom: 12px;
      font-size: 1.3em;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .test-card p {
      color: #666;
      margin-bottom: 16px;
      line-height: 1.5;
    }
    .test-btn {
      width: 100%;
      padding: 12px 24px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      transition: all 0.3s;
    }
    .test-btn:hover {
      background: #5568d3;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }
    .test-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }
    .result {
      margin-top: 16px;
      padding: 12px;
      border-radius: 8px;
      font-size: 14px;
      display: none;
    }
    .result.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
      display: block;
    }
    .result.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
      display: block;
    }
    .result.warning {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
      display: block;
    }
    .result.info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
      display: block;
    }
    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      margin-left: auto;
    }
    .status-badge.pass {
      background: #d4edda;
      color: #155724;
    }
    .status-badge.fail {
      background: #f8d7da;
      color: #721c24;
    }
    .status-badge.pending {
      background: #e2e3e5;
      color: #383d41;
    }
    .summary {
      background: white;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      margin-bottom: 30px;
    }
    .summary h2 {
      color: #333;
      margin-bottom: 20px;
    }
    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 16px;
    }
    .summary-item {
      text-align: center;
      padding: 16px;
      border-radius: 8px;
      background: #f8f9fa;
    }
    .summary-item .number {
      font-size: 2em;
      font-weight: bold;
      margin-bottom: 8px;
    }
    .summary-item .label {
      color: #666;
      font-size: 14px;
    }
    .summary-item.total .number { color: #667eea; }
    .summary-item.passed .number { color: #28a745; }
    .summary-item.failed .number { color: #dc3545; }
    .summary-item.score .number { color: #ffc107; }
    .run-all-btn {
      width: 100%;
      padding: 16px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 30px;
      transition: all 0.3s;
    }
    .run-all-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
    }
    pre {
      background: #f8f9fa;
      padding: 12px;
      border-radius: 6px;
      overflow-x: auto;
      font-size: 12px;
      margin-top: 8px;
    }
    .icon {
      font-size: 1.2em;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîê Security Test Suite</h1>
    
    <div class="summary">
      <h2>Test Resultaten</h2>
      <div class="summary-grid">
        <div class="summary-item total">
          <div class="number" id="totalTests">0</div>
          <div class="label">Totaal Tests</div>
        </div>
        <div class="summary-item passed">
          <div class="number" id="passedTests">0</div>
          <div class="label">Geslaagd</div>
        </div>
        <div class="summary-item failed">
          <div class="number" id="failedTests">0</div>
          <div class="label">Gefaald</div>
        </div>
        <div class="summary-item score">
          <div class="number" id="securityScore">-</div>
          <div class="label">Security Score</div>
        </div>
      </div>
    </div>

    <button class="run-all-btn" onclick="runAllTests()">
      üöÄ Run Alle Tests
    </button>

    <div class="test-grid">
      <!-- Test 1: Rate Limiting -->
      <div class="test-card">
        <h2>
          <span class="icon">üö¶</span>
          Rate Limiting
          <span class="status-badge pending" id="status-ratelimit">Pending</span>
        </h2>
        <p>Test of API rate limiting actief is (max 100 requests per 15 min)</p>
        <button class="test-btn" onclick="testRateLimiting()">Test Rate Limiting</button>
        <div class="result" id="result-ratelimit"></div>
      </div>

      <!-- Test 2: Security Headers -->
      <div class="test-card">
        <h2>
          <span class="icon">üõ°Ô∏è</span>
          Security Headers
          <span class="status-badge pending" id="status-headers">Pending</span>
        </h2>
        <p>Controleer of Helmet security headers aanwezig zijn</p>
        <button class="test-btn" onclick="testSecurityHeaders()">Test Headers</button>
        <div class="result" id="result-headers"></div>
      </div>

      <!-- Test 3: HTTPS Verification -->
      <div class="test-card">
        <h2>
          <span class="icon">üîí</span>
          HTTPS Check
          <span class="status-badge pending" id="status-https">Pending</span>
        </h2>
        <p>Verifieer dat API endpoints HTTPS gebruiken</p>
        <button class="test-btn" onclick="testHTTPS()">Test HTTPS</button>
        <div class="result" id="result-https"></div>
      </div>

      <!-- Test 4: Supabase RLS -->
      <div class="test-card">
        <h2>
          <span class="icon">üóÑÔ∏è</span>
          Supabase RLS
          <span class="status-badge pending" id="status-rls">Pending</span>
        </h2>
        <p>Test of Row Level Security policies actief zijn (anon key is veilig publiek!)</p>
        <button class="test-btn" onclick="testSupabaseRLS()">Test RLS</button>
        <div class="result" id="result-rls"></div>
      </div>

      <!-- Test 5: Environment Variables -->
      <div class="test-card">
        <h2>
          <span class="icon">üîë</span>
          Environment Vars
          <span class="status-badge pending" id="status-env">Pending</span>
        </h2>
        <p>Check of PRIVATE keys niet in frontend staan (anon key mag publiek!)</p>
        <button class="test-btn" onclick="testEnvVars()">Test Env Vars</button>
        <div class="result" id="result-env"></div>
      </div>

      <!-- Test 6: Auth Endpoint -->
      <div class="test-card">
        <h2>
          <span class="icon">üîê</span>
          Auth Endpoint
          <span class="status-badge pending" id="status-auth">Pending</span>
        </h2>
        <p>Test authenticatie endpoint beveiliging</p>
        <button class="test-btn" onclick="testAuthEndpoint()">Test Auth</button>
        <div class="result" id="result-auth"></div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = 'http://localhost:5050';
    let testResults = {
      total: 0,
      passed: 0,
      failed: 0
    };

    function updateSummary() {
      document.getElementById('totalTests').textContent = testResults.total;
      document.getElementById('passedTests').textContent = testResults.passed;
      document.getElementById('failedTests').textContent = testResults.failed;
      
      if (testResults.total > 0) {
        const score = Math.round((testResults.passed / testResults.total) * 10);
        document.getElementById('securityScore').textContent = score + '/10';
      }
    }

    function setTestResult(testId, status, message, details = '') {
      const statusEl = document.getElementById(`status-${testId}`);
      const resultEl = document.getElementById(`result-${testId}`);
      
      statusEl.className = `status-badge ${status === 'pass' ? 'pass' : 'fail'}`;
      statusEl.textContent = status === 'pass' ? '‚úì Pass' : '‚úó Fail';
      
      resultEl.className = `result ${status === 'pass' ? 'success' : 'error'}`;
      resultEl.innerHTML = `<strong>${message}</strong>${details ? '<pre>' + details + '</pre>' : ''}`;
      
      testResults.total++;
      if (status === 'pass') testResults.passed++;
      else testResults.failed++;
      
      updateSummary();
    }

    async function testRateLimiting() {
      const btn = event.target;
      btn.disabled = true;
      btn.textContent = 'Testing...';
      
      try {
        // Test 1: Normal request should work
        const res1 = await fetch(`${API_BASE}/api/debug`);
        if (!res1.ok) throw new Error('API niet bereikbaar');
        
        // Check for rate limit headers
        const remaining = res1.headers.get('X-RateLimit-Remaining');
        const limit = res1.headers.get('X-RateLimit-Limit');
        
        if (remaining !== null && limit !== null) {
          setTestResult('ratelimit', 'pass', 
            '‚úì Rate limiting actief!', 
            `Limit: ${limit} requests\nRemaining: ${remaining}`
          );
        } else {
          setTestResult('ratelimit', 'fail', 
            '‚úó Rate limit headers niet gevonden',
            'Headers: ' + Array.from(res1.headers.keys()).join(', ')
          );
        }
      } catch (err) {
        setTestResult('ratelimit', 'fail', '‚úó Test gefaald', err.message);
      }
      
      btn.disabled = false;
      btn.textContent = 'Test Rate Limiting';
    }

    async function testSecurityHeaders() {
      const btn = event.target;
      btn.disabled = true;
      btn.textContent = 'Testing...';
      
      try {
        const res = await fetch(`${API_BASE}/api/debug`);
        
        const headers = {
          'X-Content-Type-Options': res.headers.get('X-Content-Type-Options'),
          'X-Frame-Options': res.headers.get('X-Frame-Options'),
          'X-XSS-Protection': res.headers.get('X-XSS-Protection'),
          'Strict-Transport-Security': res.headers.get('Strict-Transport-Security')
        };
        
        const found = Object.values(headers).filter(v => v !== null).length;
        
        if (found >= 3) {
          setTestResult('headers', 'pass', 
            `‚úì ${found}/4 security headers gevonden!`,
            JSON.stringify(headers, null, 2)
          );
        } else {
          setTestResult('headers', 'fail', 
            `‚úó Slechts ${found}/4 headers gevonden`,
            JSON.stringify(headers, null, 2)
          );
        }
      } catch (err) {
        setTestResult('headers', 'fail', '‚úó Test gefaald', err.message);
      }
      
      btn.disabled = false;
      btn.textContent = 'Test Headers';
    }

    async function testHTTPS() {
      const btn = event.target;
      btn.disabled = true;
      btn.textContent = 'Testing...';
      
      try {
        const res = await fetch(`${API_BASE}/api/debug`);
        const data = await res.json();
        
        const tcBaseUrl = data.TC_BASE_URL || '';
        const isHttps = tcBaseUrl.startsWith('https://');
        
        if (isHttps) {
          setTestResult('https', 'pass', 
            '‚úì TC_BASE_URL gebruikt HTTPS!',
            `URL: ${tcBaseUrl}`
          );
        } else if (tcBaseUrl.startsWith('http://')) {
          setTestResult('https', 'fail', 
            '‚úó TC_BASE_URL gebruikt HTTP (onveilig!)',
            `URL: ${tcBaseUrl}\n\n‚ö†Ô∏è Wijzig naar HTTPS in .env`
          );
        } else {
          setTestResult('https', 'fail', 
            '‚úó TC_BASE_URL niet geconfigureerd',
            'Configureer TC_BASE_URL in server/.env'
          );
        }
      } catch (err) {
        setTestResult('https', 'fail', '‚úó Test gefaald', err.message);
      }
      
      btn.disabled = false;
      btn.textContent = 'Test HTTPS';
    }

    async function testSupabaseRLS() {
      const btn = event.target;
      btn.disabled = true;
      btn.textContent = 'Testing...';
      
      try {
        if (!window.BOLT_DB || !window.BOLT_DB.url || !window.BOLT_DB.anonKey) {
          setTestResult('rls', 'fail', 
            '‚úó Supabase config niet gevonden',
            'BOLT_DB niet geladen. Check config/bolt.js'
          );
          btn.disabled = false;
          btn.textContent = 'Test RLS';
          return;
        }
        
        // Try to access a table without auth
        const res = await fetch(`${window.BOLT_DB.url}/rest/v1/brands?select=*&limit=1`, {
          headers: {
            'apikey': window.BOLT_DB.anonKey,
            'Authorization': `Bearer ${window.BOLT_DB.anonKey}`
          }
        });
        
        if (res.status === 401 || res.status === 403) {
          setTestResult('rls', 'pass', 
            '‚úì RLS is actief! (401/403 zonder auth)',
            'Database is beschermd tegen ongeautoriseerde toegang'
          );
        } else if (res.ok) {
          const data = await res.json();
          if (data.length === 0) {
            setTestResult('rls', 'pass', 
              '‚úì RLS waarschijnlijk actief (geen data)',
              'Geen data teruggegeven zonder authenticatie'
            );
          } else {
            setTestResult('rls', 'fail', 
              '‚ö†Ô∏è RLS mogelijk niet actief!',
              `${data.length} records toegankelijk zonder auth!\n\nüö® ACTIVEER RLS IN SUPABASE DASHBOARD!`
            );
          }
        } else {
          setTestResult('rls', 'fail', 
            '‚úó Onverwachte response',
            `Status: ${res.status}\n${await res.text()}`
          );
        }
      } catch (err) {
        setTestResult('rls', 'fail', '‚úó Test gefaald', err.message);
      }
      
      btn.disabled = false;
      btn.textContent = 'Test RLS';
    }

    async function testEnvVars() {
      const btn = event.target;
      btn.disabled = true;
      btn.textContent = 'Testing...';
      
      try {
        // Check if sensitive vars are exposed in window
        const exposed = [];
        const safe = [];
        
        // Check common patterns
        const patterns = [
          'TC_PASSWORD', 'TC_USERNAME', 'TC_TOKEN', 'TC_CLIENT_SECRET',
          'OPENAI_API_KEY', 'PEXELS_API_KEY', 'SHOTSTACK_API_KEY'
        ];
        
        patterns.forEach(pattern => {
          if (window[pattern]) {
            exposed.push(pattern);
          } else {
            safe.push(pattern);
          }
        });
        
        // Check if BOLT_DB.anonKey is exposed (this is expected/acceptable)
        const boltKeyExposed = window.BOLT_DB && window.BOLT_DB.anonKey;
        
        if (exposed.length === 0) {
          setTestResult('env', 'pass', 
            '‚úì Geen PRIVATE credentials in frontend!',
            `Gecontroleerd: ${patterns.length} variabelen\n${boltKeyExposed ? '\n‚úÖ BOLT_DB.anonKey is publiek (dit is VEILIG en normaal!)' : ''}`
          );
        } else {
          setTestResult('env', 'fail', 
            '‚ö†Ô∏è PRIVATE credentials gevonden in frontend!',
            `Exposed: ${exposed.join(', ')}\n\nüö® Verwijder deze uit frontend code!\n\nLet op: Supabase anon key is OK om publiek te zijn.`
          );
        }
      } catch (err) {
        setTestResult('env', 'fail', '‚úó Test gefaald', err.message);
      }
      
      btn.disabled = false;
      btn.textContent = 'Test Env Vars';
    }

    async function testAuthEndpoint() {
      const btn = event.target;
      btn.disabled = true;
      btn.textContent = 'Testing...';
      
      try {
        const res = await fetch(`${API_BASE}/api/debug/auth`);
        const data = await res.json();
        
        // Check if response doesn't expose full tokens
        const tokenPreview = data.tokenPreview || '';
        const hasFullToken = tokenPreview.length > 50;
        
        if (res.ok && !hasFullToken) {
          setTestResult('auth', 'pass', 
            '‚úì Auth endpoint veilig!',
            `Token preview: ${tokenPreview}\nExpires in: ${data.expiresInSec}s`
          );
        } else if (hasFullToken) {
          setTestResult('auth', 'fail', 
            '‚ö†Ô∏è Volledige token ge√´xposeerd!',
            'Auth endpoint toont te veel token informatie'
          );
        } else {
          setTestResult('auth', 'fail', 
            '‚úó Auth endpoint error',
            JSON.stringify(data, null, 2)
          );
        }
      } catch (err) {
        setTestResult('auth', 'fail', '‚úó Test gefaald', err.message);
      }
      
      btn.disabled = false;
      btn.textContent = 'Test Auth';
    }

    async function runAllTests() {
      const btn = event.target;
      btn.disabled = true;
      btn.textContent = '‚è≥ Running tests...';
      
      // Reset results
      testResults = { total: 0, passed: 0, failed: 0 };
      updateSummary();
      
      // Run all tests sequentially
      await testRateLimiting();
      await new Promise(r => setTimeout(r, 500));
      
      await testSecurityHeaders();
      await new Promise(r => setTimeout(r, 500));
      
      await testHTTPS();
      await new Promise(r => setTimeout(r, 500));
      
      await testSupabaseRLS();
      await new Promise(r => setTimeout(r, 500));
      
      await testEnvVars();
      await new Promise(r => setTimeout(r, 500));
      
      await testAuthEndpoint();
      
      btn.disabled = false;
      btn.textContent = '‚úì Tests Voltooid!';
      
      setTimeout(() => {
        btn.textContent = 'üöÄ Run Alle Tests';
      }, 3000);
    }

    // Auto-run on load if ?autorun in URL
    if (window.location.search.includes('autorun')) {
      window.addEventListener('load', () => {
        setTimeout(runAllTests, 1000);
      });
    }
  </script>
</body>
</html>
