<!DOCTYPE html>
<html lang="nl">

<head>
    <meta charset="UTF-8">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Website Builder</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='18' ry='18' fill='%234CAF50'/%3E%3Ctext x='50' y='62' font-size='60' text-anchor='middle' fill='white'%3EW%3C/text%3E%3C/svg%3E">
    <script src="js/versioning.js"></script>
    <link rel="stylesheet" href="styles/main.css">
    <link rel="stylesheet" href="styles/components.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
        <div class="app-container">
        <!-- Header -->
        <header class="app-header">
            <div class="header-left">
                <h1><i class="fas fa-code"></i> Website Builder</h1>
            </div>
            <div class="header-right">
                <div class="page-meta" style="display:flex;align-items:center;gap:8px;margin-right:12px;">
                    <label for="pageTitleInput" style="color:#f8fafc;font-size:12px;opacity:.9;">Titel</label>
                    <input id="pageTitleInput" class="form-control" placeholder="Pagina titel" style="width:220px;height:28px;padding:4px 8px;border-radius:6px;border:1px solid #cbd5e1;" />
                    <label for="pageSlugInput" style="color:#f8fafc;font-size:12px;opacity:.9;">Slug</label>
                    <input id="pageSlugInput" class="form-control" placeholder="pagina-slug" style="width:180px;height:28px;padding:4px 8px;border-radius:6px;border:1px solid #cbd5e1;" />
                    <span id="pageSaveStatus" style="color:#e2e8f0;font-size:12px;margin-left:8px;opacity:.9;white-space:nowrap;">Niet opgeslagen</span>
                    <button class="btn btn-secondary" id="importTcBtn" aria-label="Importeer TC" title="Importeer Travel Compositor ID" style="margin-left:8px;">
                        <i class="fas fa-cloud-download-alt"></i> Importeer TC
                    </button>
                </div>
                <button class="btn btn-secondary" id="pagesBtn" aria-label="Paginas beheren" title="Paginas beheren">
                    <i class="fas fa-file-alt"></i> Pagina's
                </button>
                <button class="btn btn-secondary" id="newPageQuickBtn" aria-label="Nieuwe pagina" title="Snel nieuwe pagina aanmaken">
                    <i class="fas fa-file-circle-plus"></i> Nieuwe pagina
                </button>
                <button class="btn btn-secondary" id="layoutBtn" aria-label="Layout" title="Kies header & footer layout">
                    <i class="fas fa-layer-group"></i> Layout
                </button>
                <button class="btn btn-secondary" id="headerBuilderBtn" aria-label="Header Builder" title="Bewerk Header (vol scherm)">
                    <i class="fas fa-heading"></i> Header Builder
                </button>
                <button class="btn btn-secondary" id="footerBuilderBtn" aria-label="Footer Builder" title="Bewerk Footer (vol scherm)">
                    <i class="fas fa-window-maximize"></i> Footer Builder
                </button>
                <button class="btn btn-secondary" id="backToDashboardBtn" aria-label="Terug naar Dashboard" title="Ga terug naar Bolt Dashboard">
                    <i class="fas fa-arrow-left"></i> Terug naar Dashboard
                </button>
                <button class="btn btn-secondary" id="openProjectBtn" aria-label="Openen" title="Projectbestand openen (.wbproj)">
                    <i class="fas fa-folder-open"></i> Openen
                </button>
                <button class="btn btn-secondary" id="saveProjectBtn" aria-label="Opslaan" title="Project opslaan als bestand (.wbproj)">
                    <i class="fas fa-save"></i> Opslaan
                </button>
                <button class="btn btn-secondary" id="previewBtn" aria-label="Preview">
                    <i class="fas fa-eye"></i> Preview
                </button>
                <button class="btn btn-primary" id="exportBtn" aria-label="Export">
                    <i class="fas fa-download"></i> Export
                </button>
                <button class="btn btn-primary" id="publishBtn" aria-label="Publish" title="Commit & Push via PowerShell">
                    <i class="fas fa-cloud-upload-alt"></i> Publish
                </button>
                <button class="btn btn-primary" id="gitPushBtn" aria-label="Stuur naar GitHub" title="Commit & Push naar GitHub">
                    <i class="fas fa-upload"></i> Stuur naar GitHub
                </button>
            </div>
        </header>

        <div class="app-body">
            <!-- Sidebar met componenten -->
            <aside class="sidebar">
                <div class="component-categories">
                    <div class="category">
                        <h4>HERO</h4>
                        <div class="component-list">
                            <div class="component-item" draggable="true" data-component="hero-travel">
                                <i class="fas fa-mountain-sun"></i>
                                <span>Hero Travel (met overlay + zoek + kaarten)</span>
                            </div>
                            <div class="component-item" draggable="true" data-component="hero-page">
                                <i class="fas fa-image"></i>
                                <span>Hero (Pagina) – banner met groot woord</span>
                            </div>
                            <div class="component-item" draggable="true" data-component="hero-banner-cta">
                                <i class="fas fa-bullhorn"></i>
                                <span>Hero Banner + CTA (volledige breedte)</span>
                            </div>
                        </div>
                    </div>

                    <div class="category">
                        <h4>CONTENT</h4>
                        <div class="component-list">
                            <div class="component-item" draggable="true" data-component="feature-media">
                                <i class="fas fa-square-split-horizontal"></i>
                                <span>Feature + Media (tekst + beeld)</span>
                            </div>
                            <div class="component-item" draggable="true" data-component="feature-highlight">
                                <i class="fas fa-image"></i>
                                <span>Feature Highlight (foto + lijst)</span>
                            </div>
                            <div class="component-item" draggable="true" data-component="content-flex">
                                <i class="fas fa-align-left"></i>
                                <span>Content (flex)</span>
                            </div>
                        </div>
                    </div>

                    <div class="category">
                        <h4>MEDIA</h4>
                        <div class="component-list">
                            <div class="component-item" draggable="true" data-component="travel-types">
                                <i class="fas fa-th-large"></i>
                                <span>Soorten Reizen (8 kaarten)</span>
                            </div>
                            <div class="component-item" draggable="true" data-component="media-row">
                                <i class="fas fa-images"></i>
                                <span>Media Rij (foto’s / carrousel)</span>
                            </div>
                        </div>
                    </div>

                    <div class="category">
                        <h4>FORMULIEREN</h4>
                        <div class="component-list">
                            <div class="component-item" draggable="true" data-component="jotform-embed">
                                <i class="fas fa-wpforms"></i>
                                <span>Jotform Embed (inline)</span>
                            </div>
                        </div>
                    </div>

                    <div class="category">
                        <h4>REIZEN</h4>
                        <div class="component-list">
                            <div class="component-item disabled" title="Binnenkort beschikbaar">
                                <i class="fas fa-suitcase-rolling"></i>
                                <span>Komt eraan</span>
                            </div>
                        </div>
                    </div>

                    <div class="category">
                        <h4>CONTACT</h4>
                        <div class="component-list">
                            <div class="component-item" draggable="true" data-component="contact-info">
                                <i class="fas fa-address-card"></i>
                                <span>Contact Info (3 kaarten)</span>
                            </div>
                            <div class="component-item" draggable="true" data-component="contact-map-cta">
                                <i class="fas fa-map-location-dot"></i>
                                <span>Contact Map + CTA</span>
                            </div>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Canvas gebied -->
            <main class="canvas-area">
                    <div class="device-selector">
                        <button class="device-btn active" data-device="desktop">
                            <i class="fas fa-desktop"></i>
                        </button>
                        <button class="device-btn" data-device="tablet">
                            <i class="fas fa-tablet-alt"></i>
                        </button>
                        <button class="device-btn" data-device="mobile">
                            <i class="fas fa-mobile-alt"></i>
                        </button>
                    </div>
                <div class="canvas-wrapper">
                    <div class="canvas" id="canvas">
                        <div class="drop-zone">
                            <div class="drop-zone-content">
                                <i class="fas fa-plus-circle"></i>
                                <p>Sleep componenten hierheen om te beginnen</p>
                            </div>
                        </div>
                    </div>
                </div>
            </main>

            <!-- Properties panel -->
            <aside class="properties-panel">
                <h3>Eigenschappen</h3>
                <div class="properties-content" id="propertiesContent">
                    <p class="no-selection">Selecteer een element om eigenschappen te bewerken</p>
                </div>
            </aside>
        </div>
    </div>

    <!-- Preview Modal -->
    <div class="modal" id="previewModal">
        <div class="modal-content">
            <div class="modal-header">
                <button class="modal-close" id="closePreview">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <iframe id="previewFrame" title="Website preview" src="about:blank"></iframe>
            </div>
        </div>
    </div>

    <!-- Hidden file input for opening project files (.wbproj) -->
    <input type="file" id="projectFileInput" accept=".wbproj,application/json" style="display:none" />

    <!-- Optional local config for API keys (gitignored). Define window.MEDIA_CONFIG here if needed. -->
    <script src="js/config.prod.js?v=2"></script>
    <script src="js/config.local.js"></script>
    <script>
      // Step 1: Read params from both search and hash (?a=b after #) so deeplinks work
      (function initDeepLinkParams(){
        function parseHashQuery() {
          try {
            const h = location.hash || '';
            const qIndex = h.indexOf('?');
            if (qIndex === -1) return new URLSearchParams('');
            return new URLSearchParams(h.slice(qIndex + 1));
          } catch { return new URLSearchParams(''); }
        }
        function getParam(name) {
          const fromSearch = new URLSearchParams(location.search).get(name);
          if (fromSearch) return fromSearch;
          return parseHashQuery().get(name);
        }
        try {
          const brandId = getParam('brand_id');
          const token   = getParam('token');
          const api     = getParam('api');     // Edge Functions base
          const apiKey  = getParam('api_key') || getParam('apikey'); // Edge Functions API key (support both)
          const tcApi   = getParam('tc_api');  // Travel Compositor proxy base

          if (brandId) window.CURRENT_BRAND_ID = brandId;
          if (token)   window.CURRENT_TOKEN = token;
          if (api) {
            window.BOLT_API = { baseUrl: api };
            // Ensure Supabase client uses same base domain when provided via deeplink
            window.BOLT_DB = window.BOLT_DB || {};
            window.BOLT_DB.url = api.replace(/\/$/, '');
            try { console.debug('[WB] Overriding BOLT_DB.url from deeplink api =', window.BOLT_DB.url); } catch {}
          }
          if (apiKey) {
            window.BOLT_API = window.BOLT_API || {};
            window.BOLT_API.apiKey = apiKey;
          }
          if (tcApi)   window.TC_API_BASE = tcApi.replace(/\/$/, '');

          // Also allow config.local.js to set BOLT_API if not provided in URL
          window.BOLT_API = window.BOLT_API || (window.BOLT && window.BOLT.API) || null;
        } catch (e) { console.warn('Query parsing failed', e); }

        // Keep globals in sync if router changes the hash
        window.addEventListener('hashchange', () => {
          try {
            const brandId = getParam('brand_id');
            const token   = getParam('token');
            const api     = getParam('api');
            const apiKey  = getParam('api_key') || getParam('apikey');
            const tcApi   = getParam('tc_api');
            if (brandId) window.CURRENT_BRAND_ID = brandId;
            if (token)   window.CURRENT_TOKEN = token;
            if (api)     {
              window.BOLT_API = window.BOLT_API || {}; window.BOLT_API.baseUrl = api;
              window.BOLT_DB = window.BOLT_DB || {}; window.BOLT_DB.url = api.replace(/\/$/, '');
              try { console.debug('[WB] (hashchange) Overriding BOLT_DB.url from api =', window.BOLT_DB.url); } catch {}
            }
            if (apiKey)  { window.BOLT_API = window.BOLT_API || {}; window.BOLT_API.apiKey = apiKey; }
            if (tcApi)   window.TC_API_BASE = tcApi.replace(/\/$/, '');
          } catch {}
        });
      })();
    </script>
    <script>
        if (!window.BOLT_DB) {
          console.error('BOLT_DB niet geladen. Controleer js/config.local.js');
        } else {
          window.db = window.supabase.createClient(window.BOLT_DB.url, window.BOLT_DB.anonKey);
          // Health check: log DB reachability in console
          try {
            fetch(window.BOLT_DB.url + '/auth/v1/health')
              .then(r => console.log('DB health status:', r.status))
              .catch(e => console.warn('DB health check failed:', e.message || e));
          } catch (e) {
            console.warn('DB health check error:', e);
          }
        }
      </script>
    <script src="js/layouts.js?v=20251006-1735"></script>
    <script src="js/iconPicker.js?v=20251006-1735"></script>
    <script src="js/components.js?v=20251006-1735"></script>
    <script src="js/dragdrop.js?v=20251006-1735"></script>
    <script src="js/media.js?v=20251006-1735"></script>
    <script src="js/properties.js?v=20251006-1735"></script>
    <script src="js/export.js?v=20251006-1735"></script>
    <script src="js/publish.js?v=20251006-1735"></script>
    <script src="js/router.js?v=20251006-1735"></script>
    <script src="js/views/menuFooterView.js?v=20251006-1735"></script>
    <script src="js/fnClient.js?v=20251006-1735"></script>
    <script src="js/menuRender.js?v=20251006-1735"></script>
    <script src="js/layoutsBuilder.js?v=20251006-1735"></script>
    <script src="js/brandHydrator.js?v=20251006-1735"></script>
    <script src="js/main.js?v=20251006-1735"></script>
    <script>
      // Ensure "Terug naar Dashboard" preserves auth query params
      document.addEventListener('DOMContentLoaded', () => {
        try {
          const btn = document.getElementById('backToDashboardBtn');
          if (!btn) return;
          btn.onclick = (e) => {
            try { e.preventDefault(); } catch {}
            const apiBase = (window.BOLT_API && window.BOLT_API.baseUrl) || '';
            if (!apiBase) {
              try { window.websiteBuilder?.showNotification('Geen Bolt API baseUrl gevonden. Stel ?api= in de URL.', 'info'); } catch {}
              return;
            }
            const qp = new URLSearchParams();
            if (window.CURRENT_BRAND_ID) qp.set('brand_id', window.CURRENT_BRAND_ID);
            if (window.CURRENT_TOKEN) qp.set('token', window.CURRENT_TOKEN);
            if (window.BOLT_API && window.BOLT_API.apiKey) qp.set('apikey', window.BOLT_API.apiKey);
            const url = `${apiBase.replace(/\/$/, '')}/admin/website/pages${qp.toString() ? `?${qp.toString()}` : ''}`;
            window.location.href = url;
          };
        } catch {}
      });
    </script>
    <script>
      // Bolt header customization: keep only relevant buttons in deeplink context
      function applyBoltHeaderVisibility(){
        try {
          const isBolt = !!(window.BOLT_API && window.BOLT_API.baseUrl);
          if (!isBolt) return;
          const pageMeta = document.querySelector('.app-header .page-meta');
          if (pageMeta) pageMeta.style.display = '';
          // Hide legacy/buttons we don't want in Bolt
          const hideIds = [
            'importTcBtn',
            'headerBuilderBtn',
            'footerBuilderBtn',
            'openProjectBtn',
            'exportBtn',
            'gitPushBtn',
            'publishBtn',
            'layoutBtn' // hide layout to reduce clutter; can re-enable later if needed
          ];
          hideIds.forEach(id => { const el = document.getElementById(id); if (el) el.style.display = 'none'; });
          // Ensure keep-visible
          ['pagesBtn','backToDashboardBtn','saveProjectBtn','previewBtn'].forEach(id => {
            const el = document.getElementById(id); if (el) el.style.display = '';
          });
        } catch {}
      }

      document.addEventListener('DOMContentLoaded', () => {
        try {
          const isBolt = !!(window.BOLT_API && window.BOLT_API.baseUrl);
          if (!isBolt) return;

          const headerRight = document.querySelector('.app-header .header-right');
          applyBoltHeaderVisibility();

          // Insert Bouwtype dropdown (only once)
          if (headerRight && !document.getElementById('topModeSelect')){
            const wrap = document.createElement('div');
            wrap.style.display = 'flex'; wrap.style.alignItems = 'center'; wrap.style.gap = '8px';
            const lbl = document.createElement('label'); lbl.textContent = 'Bouwtype'; lbl.style.cssText = 'color:#f8fafc;font-size:12px;opacity:.9;';
            const sel = document.createElement('select'); sel.id = 'topModeSelect'; sel.className = 'form-control'; sel.style.cssText = 'height:28px;padding:4px 8px;border-radius:6px;border:1px solid #cbd5e1;min-width:180px;';
            sel.innerHTML = `
              <option value="page">Web pagina</option>
              <option value="travel">Reizen</option>
              <option value="news">Nieuwsartikel</option>
              <option value="destination">Bestemmingspagina</option>
              <option value="menu">Menu & footer</option>`;
            wrap.appendChild(lbl); wrap.appendChild(sel);
            headerRight.insertBefore(wrap, headerRight.firstChild);
            try {
              const hashMode = (location.hash.match(/#\/mode\/([a-z]+)/i)||[])[1];
              const storedMode = localStorage.getItem('wb_mode');
              const mode = hashMode || storedMode || 'page'; sel.value = mode;
            } catch {}
            sel.onchange = () => { try { location.hash = `#/mode/${sel.value}`; } catch {} };
          }

          // Re-apply on hash changes and DOM mutations (e.g., after actions that reflow header)
          window.addEventListener('hashchange', () => applyBoltHeaderVisibility());
          try {
            const header = document.querySelector('.app-header');
            if (header) {
              const mo = new MutationObserver(() => applyBoltHeaderVisibility());
              mo.observe(header, { childList: true, subtree: true, attributes: true });
            }
          } catch {}

          // Save button: route to Pages or News depending on mode
          const saveBtn = document.getElementById('saveProjectBtn');
          if (saveBtn){
            saveBtn.onclick = async () => {
              try {
                const saved = localStorage.getItem('wb_project');
                let cur = null;
                try {
                  if (saved) {
                    const d = JSON.parse(saved);
                    const pages = Array.isArray(d.pages) ? d.pages : [];
                    const currentId = d.currentPageId || (pages[0] && pages[0].id);
                    cur = pages.find(p => p.id === currentId) || pages[0] || null;
                  }
                } catch {}
                let title = (cur && cur.name) || '';
                let slug = (cur && cur.slug) || '';
                if (!title) title = prompt('Pagina titel', 'Nieuwe pagina') || 'Nieuwe pagina';
                if (!slug) {
                  const base = (title||'Nieuwe pagina').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'');
                  slug = prompt('Pagina slug', base) || base || 'pagina';
                }
                try {
                  window.websiteBuilder && (function(){
                    const wb = window.websiteBuilder;
                    const p = (wb.pages||[]).find(x=>x.id===wb.currentPageId) || (wb.pages||[])[0];
                    if (p){ p.name = title; p.slug = slug; }
                    wb.persistPagesToLocalStorage();
                  })();
                } catch {}
                try { window.websiteBuilder?.saveProject(true); } catch {}

                try {
                  const brand_id = window.CURRENT_BRAND_ID;
                  if (!brand_id) throw new Error('brand_id ontbreekt');
                  const contentJson = (typeof window.exportBuilderAsJSON === 'function') ? window.exportBuilderAsJSON() : { title, slug };
                  contentJson.title = title; contentJson.slug = slug;
                  const htmlString = (typeof window.exportBuilderAsHTML === 'function') ? window.exportBuilderAsHTML(contentJson) : '';
                  if (!window.BuilderPublishAPI) throw new Error('Publish helpers niet geladen');
                  const mode = (window.websiteBuilder && typeof window.websiteBuilder.getCurrentMode === 'function') ? window.websiteBuilder.getCurrentMode() : 'page';
                  if (mode === 'news' && window.BuilderPublishAPI.news) {
                    await window.BuilderPublishAPI.news.saveDraft({
                      brand_id,
                      title: contentJson.title,
                      slug: contentJson.slug,
                      content: { json: contentJson, html: htmlString },
                      status: 'draft'
                    });
                    try { window.websiteBuilder?.showNotification('📰 Concept opgeslagen (Nieuws)', 'success'); } catch {}
                  } else if ((mode === 'destination' || mode === 'destinations') && window.BuilderPublishAPI.destinations) {
                    await window.BuilderPublishAPI.destinations.saveDraft({
                      brand_id,
                      title: contentJson.title,
                      slug: contentJson.slug,
                      content: { json: contentJson, html: htmlString },
                      status: 'draft'
                    });
                    try { window.websiteBuilder?.showNotification('🗺️ Concept opgeslagen (Bestemming)', 'success'); } catch {}
                  } else {
                    await window.BuilderPublishAPI.saveDraft({ brand_id, title, slug, content_json: contentJson });
                    try { window.websiteBuilder?.showNotification('💾 Concept opgeslagen (lokaal + Bolt-draft)', 'success'); } catch {}
                  }
                } catch (e) {
                  console.warn('Draft opslaan mislukt:', e?.message||e);
                }
              } catch (e) { console.warn(e); }
            };
          }
        } catch {}
      });
    </script>
  </body>
</html>
