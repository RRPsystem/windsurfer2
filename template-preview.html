<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Template Preview</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        
        #preview-frame {
            width: 100%;
            height: 100vh;
            border: none;
            display: none;
        }
        
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            font-size: 18px;
            color: #666;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
    </style>
</head>
<body>
    <div id="loading" class="loading">
        <div>⏳ Preview laden...</div>
    </div>
    <iframe id="preview-frame"></iframe>

    <script>
        // Get preview ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const previewId = urlParams.get('id');
        
        console.log('[Preview] Preview ID:', previewId);
        
        if (!previewId) {
            document.getElementById('loading').innerHTML = `
                <div style="text-align:center;">
                    <p>❌ Geen preview ID</p>
                    <p style="font-size:14px;color:#999;">Klik op "Preview" in de editor.</p>
                </div>
            `;
        } else {
            // Get HTML from sessionStorage
            const previewHTML = sessionStorage.getItem(`preview_${previewId}`);
            
            console.log('[Preview] HTML found:', !!previewHTML);
            console.log('[Preview] HTML length:', previewHTML ? previewHTML.length : 0);
            
            if (previewHTML) {
                try {
                    console.log('[Preview] Creating iframe and injecting HTML...');
                    
                    // Create iframe and inject HTML
                    const iframe = document.getElementById('preview-frame');
                    
                    // Wait for iframe to be ready
                    iframe.onload = function() {
                        console.log('[Preview] Iframe loaded, injecting HTML...');
                        
                        try {
                            const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                            
                            // Write HTML to iframe
                            iframeDoc.open();
                            iframeDoc.write(previewHTML);
                            iframeDoc.close();
                            
                            console.log('[Preview] HTML injected successfully');
                            console.log('[Preview] Checking for base tag...');
                            
                            const baseTag = iframeDoc.querySelector('base');
                            if (baseTag) {
                                console.log('[Preview] Base tag found:', baseTag.href);
                            } else {
                                console.warn('[Preview] No base tag found - CSS/JS may not load correctly');
                            }
                            
                            // Hide loading, show iframe after a short delay to allow resources to load
                            setTimeout(() => {
                                document.getElementById('loading').style.display = 'none';
                                iframe.style.display = 'block';
                                console.log('[Preview] Preview ready!');
                            }, 1000);
                            
                            // Clean up sessionStorage
                            sessionStorage.removeItem(`preview_${previewId}`);
                        } catch (err) {
                            console.error('[Preview] Error injecting HTML:', err);
                            document.getElementById('loading').innerHTML = `
                                <div style="text-align:center;">
                                    <p>❌ Fout bij injecteren HTML</p>
                                    <p style="font-size:14px;color:#999;">${err.message}</p>
                                </div>
                            `;
                        }
                    };
                    
                    // Set iframe src to trigger onload
                    iframe.src = 'about:blank';
                    
                } catch (error) {
                    console.error('[Preview] Error:', error);
                    document.getElementById('loading').innerHTML = `
                        <div style="text-align:center;">
                            <p>❌ Fout bij laden preview</p>
                            <p style="font-size:14px;color:#999;">${error.message}</p>
                        </div>
                    `;
                }
            } else {
                document.getElementById('loading').innerHTML = `
                    <div style="text-align:center;">
                        <p>❌ Preview niet gevonden</p>
                        <p style="font-size:14px;color:#999;">De preview is verlopen of niet beschikbaar.</p>
                        <p style="font-size:14px;color:#999;">Ga terug naar de editor en klik opnieuw op "Preview".</p>
                    </div>
                `;
            }
        }
    </script>
</body>
</html>
